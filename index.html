<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>1403 Vision Scouting App</title>
<style>
:root {
  --green: #2d6a4f;
  --green-light: #40916c;
  --green-dark: #1b4332;
  --green-faint: #d8f3dc;
  --white: #ffffff;
  --danger: #c0392b;
}
[data-theme="dark"] {
  --bg: #0d1f17;
  --bg2: #152a1e;
  --bg3: #1e3a2a;
  --border: #2d6a4f;
  --text: #e8f5e9;
  --text2: #a5d6a7;
  --text3: #66bb6a;
  --card-shadow: 0 2px 8px rgba(0,0,0,0.5);
  --toggle-bg: #1b4332;
  --input-bg: #0d1f17;
  --header-bg: #0a1a10;
}
[data-theme="light"] {
  --bg: #f1f8f4;
  --bg2: #ffffff;
  --bg3: #d8f3dc;
  --border: #40916c;
  --text: #1b4332;
  --text2: #2d6a4f;
  --text3: #40916c;
  --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
  --toggle-bg: #b7e4c7;
  --input-bg: #f9fdf9;
  --header-bg: #1b4332;
}
[data-theme="cute"] {
  --bg: #fff0f6;
  --bg2: #ffffff;
  --bg3: #ffd6e8;
  --border: #f78db8;
  --text: #6b2d4e;
  --text2: #c2185b;
  --text3: #e91e8c;
  --card-shadow: 0 2px 8px rgba(247,141,184,0.2);
  --toggle-bg: #ffc0d9;
  --input-bg: #fff8fb;
  --header-bg: #f06292;
  --green: #f06292;
  --green-light: #f78db8;
  --green-dark: #c2185b;
  --green-faint: #ffd6e8;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; transition: background 0.2s, color 0.2s; }

header { background: var(--header-bg); color: #fff; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--green-light); position: sticky; top: 0; z-index: 100; }
header h1 { font-size: 1.3rem; font-weight: 800; letter-spacing: 0.02em; }
header h1 span { color: #74c69d; }
.theme-btn { background: var(--bg3); border: 2px solid var(--green-light); color: var(--text3); border-radius: 8px; padding: 0.4rem 0.85rem; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.theme-btn:hover { background: var(--green); color: #fff; }

.page { max-width: 700px; margin: 0 auto; padding: 1.2rem 1rem 5rem; }

.card { background: var(--bg2); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem 1.25rem 1rem; margin-bottom: 1.1rem; box-shadow: var(--card-shadow); }
.card-title { font-size: 0.72rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1.5px solid var(--border); }

.field { margin-bottom: 0.9rem; }
.field:last-child { margin-bottom: 0; }
.field-label-row { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.35rem; }
.field-label-row label { font-size: 0.9rem; font-weight: 700; color: var(--text); }
.req { color: #ff6b6b; font-size: 0.85rem; }
.info-btn { width: 20px; height: 20px; border-radius: 50%; border: 1.5px solid var(--text3); background: transparent; color: var(--text3); font-size: 0.7rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
.info-btn:hover { background: var(--green); color: #fff; border-color: var(--green); }

input[type="text"], textarea, select {
  width: 100%; padding: 0.65rem 0.85rem; border: 2px solid var(--border); border-radius: 8px;
  font-size: 1rem; color: var(--text); background: var(--input-bg); transition: border-color 0.2s;
  -webkit-appearance: none;
}
input[type="text"]:focus, textarea:focus, select:focus { outline: none; border-color: var(--green-light); }
textarea { resize: vertical; min-height: 90px; font-family: inherit; }
select option { background: var(--bg2); }

.stepper { display: flex; align-items: center; border: 2px solid var(--border); border-radius: 8px; overflow: hidden; width: 100%; }
.stepper-btn { background: var(--bg3); border: none; color: var(--text); font-size: 1.2rem; font-weight: 700; width: 38px; height: 44px; cursor: pointer; flex-shrink: 0; transition: background 0.15s; display: flex; align-items: center; justify-content: center; }
.stepper-btn:hover { background: var(--green); color: #fff; }
.stepper-btn:active { background: var(--green-dark); }
.stepper-val { flex: 1; text-align: center; font-size: 1rem; font-weight: 700; color: var(--text); background: var(--input-bg); border: none; height: 44px; outline: none; min-width: 0; }
.stepper-val::-webkit-inner-spin-button, .stepper-val::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.stepper-val { -moz-appearance: textfield; }
.row2 .stepper-btn { width: 32px; height: 40px; font-size: 1.1rem; }
.row2 .stepper-val { height: 40px; font-size: 0.95rem; }

.bool-row { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
.bool-row .field-label-row { margin-bottom: 0; flex: 1; }
.toggle { position: relative; width: 56px; height: 30px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; inset: 0; background: var(--toggle-bg); border: 2px solid var(--border); border-radius: 30px; cursor: pointer; transition: background 0.2s, border-color 0.2s; }
.slider:before { content: ''; position: absolute; width: 22px; height: 22px; left: 2px; top: 2px; background: var(--text2); border-radius: 50%; transition: transform 0.2s, background 0.2s; }
.toggle input:checked + .slider { background: var(--green); border-color: var(--green-light); }
.toggle input:checked + .slider:before { transform: translateX(26px); background: #fff; }

.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; }

.timer-display { font-size: 2.2rem; font-weight: 800; text-align: center; color: var(--text3); font-variant-numeric: tabular-nums; letter-spacing: 0.05em; margin: 0.5rem 0; }
.timer-btns { display: flex; gap: 0.6rem; }
.timer-btn { flex: 1; padding: 0.75rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s, transform 0.1s; }
.timer-btn:active { transform: scale(0.97); }
.btn-start { background: var(--green); color: #fff; }
.btn-pause { background: #e67e22; color: #fff; }
.btn-reset-t { background: var(--bg3); color: var(--text); border: 2px solid var(--border); }

.collapsible { overflow: hidden; transition: max-height 0.4s ease, opacity 0.4s ease; max-height: 9999px; opacity: 1; }
.collapsible.collapsed { max-height: 0; opacity: 0; pointer-events: none; }

.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; padding: 1.5rem; }
.modal-overlay.open { display: flex; }
.modal { background: var(--bg2); border: 2px solid var(--green-light); border-radius: 14px; padding: 1.5rem; max-width: 420px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
.modal h3 { color: var(--text3); font-size: 1rem; margin-bottom: 0.6rem; }
.modal p { color: var(--text); font-size: 0.92rem; line-height: 1.5; }
.modal-close { margin-top: 1.1rem; width: 100%; padding: 0.7rem; background: var(--green); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; }

/* CYCLE STAMP FIELD */
.cycle-field { background: var(--bg3); border: 2px solid var(--border); border-radius: 8px; padding: 0.75rem; }
.cycle-stats { display: flex; gap: 0.5rem; margin-bottom: 0.6rem; }
.cycle-stat { flex: 1; background: var(--input-bg); border: 1.5px solid var(--border); border-radius: 6px; padding: 0.4rem 0.5rem; text-align: center; }
.cycle-stat-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text2); }
.cycle-stat-val { font-size: 1.1rem; font-weight: 800; color: var(--text3); }
.cycle-btns { display: flex; gap: 0.5rem; }
.score-btn { flex: 1; padding: 0.75rem; background: var(--green); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 800; cursor: pointer; transition: opacity 0.15s, transform 0.1s; }
.score-btn:active { transform: scale(0.97); }
.score-btn:disabled { opacity: 0.35; cursor: not-allowed; }
.undo-btn { padding: 0.75rem 0.85rem; background: var(--bg2); color: var(--text2); border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.15s; }
.undo-btn:hover { border-color: var(--danger); color: var(--danger); }
.undo-btn:disabled { opacity: 0.3; cursor: not-allowed; }

.action-btns { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem; }
.gen-btn { padding: 1rem; background: var(--green); color: #fff; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: background 0.2s, transform 0.1s; letter-spacing: 0.03em; }
.gen-btn:hover { background: var(--green-light); }
.gen-btn:active { transform: scale(0.98); }
.rst-btn { padding: 0.8rem; background: transparent; color: var(--text2); border: 2px solid var(--border); border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.rst-btn:hover { border-color: var(--danger); color: var(--danger); }

#qrOutput { display: none; text-align: center; margin-top: 1.1rem; background: var(--bg2); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.5rem; }
#qrOutput p { font-size: 0.82rem; color: var(--text2); margin-top: 0.75rem; }
#qrCanvas { border: 4px solid var(--green); border-radius: 10px; }

.dep-fields { background: var(--bg3); border-radius: 8px; padding: 0.85rem; margin-top: 0.75rem; border: 1.5px dashed var(--border); }

@media (max-width: 480px) { .row2 { grid-template-columns: 1fr; } header h1 { font-size: 1.05rem; } }
</style>
</head>
<body>
<header>
  <h1><span>1403</span> Vision Scouting App</h1>
  <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è Light</button>
</header>

<div class="page">
  <div class="card">
    <div class="card-title">‚ö° Prematch Information</div>

    <div class="field">
      <div class="field-label-row">
        <label>Name <span class="req">*</span></label>
        <button class="info-btn" onclick="showInfo('Name','The name of the scouter filling out this form. This field is NOT reset between matches.')">i</button>
      </div>
      <input type="text" id="f_name" placeholder="Your name">
    </div>

    <div class="field">
      <div class="field-label-row">
        <label>Match Number <span class="req">*</span></label>
        <button class="info-btn" onclick="showInfo('Match Number','The current match number being scouted. Use + / ‚àí to increment. Minimum value: 0. Resets after submission.')">i</button>
      </div>
      <div class="stepper">
        <button class="stepper-btn" onclick="step('f_match',-1)">‚àí</button>
        <input class="stepper-val" type="number" id="f_match" value="0" min="0" onchange="clamp('f_match',0)">
        <button class="stepper-btn" onclick="step('f_match',1)">+</button>
      </div>
    </div>

    <div class="field">
      <div class="field-label-row">
        <label>Team Number <span class="req">*</span></label>
        <button class="info-btn" onclick="showInfo('Team Number','The FRC team number of the robot being scouted. Minimum value: 0. Resets after submission.')">i</button>
      </div>
      <div class="stepper">
        <button class="stepper-btn" onclick="step('f_team',-1)">‚àí</button>
        <input class="stepper-val" type="number" id="f_team" value="0" min="0" onchange="clamp('f_team',0)">
        <button class="stepper-btn" onclick="step('f_team',1)">+</button>
      </div>
    </div>

    <div class="field">
      <div class="field-label-row">
        <label>Scouting Position <span class="req">*</span></label>
        <button class="info-btn" onclick="showInfo('Scouting Position','Which alliance position this scouter is assigned to. Defaults to Red 1. Resets after submission.')">i</button>
      </div>
      <select id="f_pos">
        <option value="Red 1" selected>Red 1</option>
        <option value="Red 2">Red 2</option>
        <option value="Red 3">Red 3</option>
        <option value="Blue 1">Blue 1</option>
        <option value="Blue 2">Blue 2</option>
        <option value="Blue 3">Blue 3</option>
      </select>
    </div>

    <div class="field">
      <div class="bool-row">
        <div class="field-label-row">
          <label>Showed Up? <span class="req">*</span></label>
          <button class="info-btn" onclick="showInfo('Showed Up?','Whether the team actually appeared on the field. If set to No, the rest of the form collapses. Default: Yes.')">i</button>
        </div>
        <label class="toggle"><input type="checkbox" id="f_showed" checked onchange="toggleShowedUp()"><span class="slider"></span></label>
      </div>
    </div>

    <div class="collapsible" id="mainForm">
      <div class="field" style="margin-top:0.6rem;">
        <div class="field-label-row">
          <label>Starting Side <span class="req">*</span></label>
          <button class="info-btn" onclick="showInfo('Starting Side','Which side of the field the robot starts on. Resets after submission.')">i</button>
        </div>
        <select id="f_startside">
          <option value="Center" selected>Center</option>
          <option value="Depot Side">Depot Side</option>
          <option value="Non-Depot Side">Non-Depot Side</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label-row">
          <label>Match Timer</label>
          <button class="info-btn" onclick="showInfo('Match Timer','Start this timer at the beginning of the match. Cycle stamp buttons only work while this timer is running.')">i</button>
        </div>
        <div class="timer-display" id="timerDisplay">0:00</div>
        <div class="timer-btns">
          <button class="timer-btn btn-start" id="timerStartBtn" onclick="timerToggle()">‚ñ∂ Start</button>
          <button class="timer-btn btn-reset-t" onclick="timerReset()">‚Ü∫ Reset</button>
        </div>
      </div>

      <!-- AUTO -->
      <div class="card-title" style="margin-top:1rem;">ü§ñ Autonomous</div>

      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Climbed Tower?</label>
            <button class="info-btn" onclick="showInfo('Climbed Tower? (Auto)','Did the robot successfully climb the tower during autonomous?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_climbed"><span class="slider"></span></label>
        </div>
      </div>
      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Attempted Climb (Unsuccessful)?</label>
            <button class="info-btn" onclick="showInfo('Attempted Climb (Unsuccessful)?','Did the robot attempt to climb during auto but fail?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_attempted_climb"><span class="slider"></span></label>
        </div>
      </div>

      <div class="field">
        <div class="field-label-row"><label>Fuel Scored (Auto)</label><button class="info-btn" onclick="showInfo('Fuel Scored (Auto)','Tap Scoring each time the robot scores a fuel game piece in auto. Only works while the timer is running. Records cycle count and average cycle time.')">i</button></div>
        <div class="cycle-field">
          <div class="cycle-stats">
            <div class="cycle-stat"><div class="cycle-stat-label">Cycles</div><div class="cycle-stat-val" id="cy_fuel_scored_count">0</div></div>
            <div class="cycle-stat"><div class="cycle-stat-label">Avg Cycle</div><div class="cycle-stat-val" id="cy_fuel_scored_avg">‚Äî</div></div>
          </div>
          <div class="cycle-btns">
            <button class="score-btn" id="sb_fuel_scored" onclick="stampCycle('fuel_scored')" disabled>üéØ Scoring</button>
            <button class="undo-btn" id="ub_fuel_scored" onclick="undoCycle('fuel_scored')" disabled>‚Ü© Undo</button>
          </div>
        </div>
      </div>

      <div class="field">
        <div class="field-label-row"><label>Fuel Missed (Auto)</label><button class="info-btn" onclick="showInfo('Fuel Missed (Auto)','Number of fuel game pieces missed during autonomous. Minimum: 0.')">i</button></div>
        <div class="stepper"><button class="stepper-btn" onclick="step('f_fuel_missed',-1)">‚àí</button><input class="stepper-val" type="number" id="f_fuel_missed" value="0" min="0" onchange="clamp('f_fuel_missed',0)"><button class="stepper-btn" onclick="step('f_fuel_missed',1)">+</button></div>
      </div>

      <div class="field">
        <div class="field-label-row"><label>Fuel Shot/Fed (Auto)</label><button class="info-btn" onclick="showInfo('Fuel Shot/Fed (Auto)','Tap Scoring each time the robot shoots or feeds fuel in auto. Only works while the timer is running.')">i</button></div>
        <div class="cycle-field">
          <div class="cycle-stats">
            <div class="cycle-stat"><div class="cycle-stat-label">Cycles</div><div class="cycle-stat-val" id="cy_fuel_shotfed_count">0</div></div>
            <div class="cycle-stat"><div class="cycle-stat-label">Avg Cycle</div><div class="cycle-stat-val" id="cy_fuel_shotfed_avg">‚Äî</div></div>
          </div>
          <div class="cycle-btns">
            <button class="score-btn" id="sb_fuel_shotfed" onclick="stampCycle('fuel_shotfed')" disabled>üéØ Scoring</button>
            <button class="undo-btn" id="ub_fuel_shotfed" onclick="undoCycle('fuel_shotfed')" disabled>‚Ü© Undo</button>
          </div>
        </div>
      </div>



      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Crossed Bump?</label>
            <button class="info-btn" onclick="showInfo('Crossed Bump?','Did the robot cross the bump during autonomous?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_bump"><span class="slider"></span></label>
        </div>
      </div>
      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Crossed Trench?</label>
            <button class="info-btn" onclick="showInfo('Crossed Trench?','Did the robot cross the trench during autonomous?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_trench"><span class="slider"></span></label>
        </div>
      </div>

      <!-- TELEOP -->
      <div class="card-title" style="margin-top:1rem;">üïπÔ∏è Teleop</div>

      <div class="field">
        <div class="field-label-row"><label>Fuel Scored (Teleop)</label><button class="info-btn" onclick="showInfo('Fuel Scored (Teleop)','Tap Scoring each time the robot scores a fuel game piece in teleop. Only works while the timer is running.')">i</button></div>
        <div class="cycle-field">
          <div class="cycle-stats">
            <div class="cycle-stat"><div class="cycle-stat-label">Cycles</div><div class="cycle-stat-val" id="cy_fuel_scored_t_count">0</div></div>
            <div class="cycle-stat"><div class="cycle-stat-label">Avg Cycle</div><div class="cycle-stat-val" id="cy_fuel_scored_t_avg">‚Äî</div></div>
          </div>
          <div class="cycle-btns">
            <button class="score-btn" id="sb_fuel_scored_t" onclick="stampCycle('fuel_scored_t')" disabled>üéØ Scoring</button>
            <button class="undo-btn" id="ub_fuel_scored_t" onclick="undoCycle('fuel_scored_t')" disabled>‚Ü© Undo</button>
          </div>
        </div>
      </div>

      <div class="field">
        <div class="field-label-row"><label>Fuel Fed (Teleop)</label><button class="info-btn" onclick="showInfo('Fuel Fed (Teleop)','Tap Scoring each time the robot feeds fuel in teleop. Only works while the timer is running.')">i</button></div>
        <div class="cycle-field">
          <div class="cycle-stats">
            <div class="cycle-stat"><div class="cycle-stat-label">Cycles</div><div class="cycle-stat-val" id="cy_fuel_fed_t_count">0</div></div>
            <div class="cycle-stat"><div class="cycle-stat-label">Avg Cycle</div><div class="cycle-stat-val" id="cy_fuel_fed_t_avg">‚Äî</div></div>
          </div>
          <div class="cycle-btns">
            <button class="score-btn" id="sb_fuel_fed_t" onclick="stampCycle('fuel_fed_t')" disabled>üéØ Scoring</button>
            <button class="undo-btn" id="ub_fuel_fed_t" onclick="undoCycle('fuel_fed_t')" disabled>‚Ü© Undo</button>
          </div>
        </div>
      </div>



      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Crossed Field / Played Defense?</label>
            <button class="info-btn" onclick="showInfo('Crossed Field / Played Defense?','Did the robot cross the field or play defense during teleop?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_defense"><span class="slider"></span></label>
        </div>
      </div>

      <!-- ENDGAME -->
      <div class="card-title" style="margin-top:1rem;">üèÅ Endgame</div>

      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Climbed Tower?</label>
            <button class="info-btn" onclick="showInfo('Climbed Tower? (Teleop)','Did the robot successfully climb the tower during teleop?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_climbed_t"><span class="slider"></span></label>
        </div>
      </div>
      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Attempted Climb (Unsuccessful)?</label>
            <button class="info-btn" onclick="showInfo('Attempted Climb (Unsuccessful)? (Teleop)','Did the robot attempt to climb during teleop but fail?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_attempted_climb_t"><span class="slider"></span></label>
        </div>
      </div>

      <div class="field">
        <div class="field-label-row">
          <label>Climbed Tower (Endgame)</label>
          <button class="info-btn" onclick="showInfo('Climbed Tower (Endgame)','The result of the robot\'s tower climb at end of match.')">i</button>
        </div>
        <select id="f_climb_end">
          <option value="Didn't Climb" selected>Didn't Climb</option>
          <option value="Unsuccessfully Attempted Climb">Unsuccessfully Attempted Climb</option>
          <option value="Level 1">Level 1</option>
          <option value="Level 2">Level 2</option>
          <option value="Level 3">Level 3</option>
        </select>
      </div>
      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Kept Scoring / Playing Until End?</label>
            <button class="info-btn" onclick="showInfo('Kept Scoring / Playing Until End?','Did the robot continue actively playing until the match ended?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_kept_scoring"><span class="slider"></span></label>
        </div>
      </div>

      <!-- POSTMATCH -->
      <div class="card-title" style="margin-top:1rem;">üìã Postmatch</div>

      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Died?</label>
            <button class="info-btn" onclick="showInfo('Died?','Did the robot lose battery or stop functioning during the match? Enabling this reveals timestamp fields.')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_died" onchange="toggleDied()"><span class="slider"></span></label>
        </div>
        <div class="dep-fields collapsible collapsed" id="diedFields">
          <div class="field" style="margin-bottom:0.75rem;">
            <div class="bool-row">
              <div class="field-label-row">
                <label>Approx. Time Robot Died</label>
                <button class="info-btn" onclick="showInfo('Approx. Time Robot Died','Timestamp from the match timer when the robot died. Always included in QR output.')">i</button>
              </div>
              <button class="timer-btn btn-pause" style="width:auto;padding:0.4rem 0.9rem;font-size:0.85rem;" onclick="stampDied()">üìå Stamp</button>
            </div>
            <input type="text" id="f_time_died" placeholder="Timer not running" readonly style="margin-top:0.4rem;background:var(--bg3);">
          </div>
          <div class="field" style="margin-bottom:0;">
            <div class="bool-row">
              <div class="field-label-row">
                <label>Functioning Again?</label>
                <button class="info-btn" onclick="showInfo('Functioning Again?','Did the robot start functioning again after dying? Always included in QR output.')">i</button>
              </div>
              <button class="timer-btn btn-start" style="width:auto;padding:0.4rem 0.9rem;font-size:0.85rem;" onclick="stampFunctioning()">üìå Stamp</button>
            </div>
            <input type="text" id="f_functioning" placeholder="Timer not running" readonly style="margin-top:0.4rem;background:var(--bg3);">
          </div>
        </div>
      </div>

      <div class="field">
        <div class="bool-row">
          <div class="field-label-row">
            <label>Tipped Over?</label>
            <button class="info-btn" onclick="showInfo('Tipped Over?','Did the robot tip over during the match?')">i</button>
          </div>
          <label class="toggle"><input type="checkbox" id="f_tipped"><span class="slider"></span></label>
        </div>
      </div>

    </div><!-- end collapsible mainForm -->

    <div class="field" style="margin-top:0.75rem;">
      <div class="field-label-row">
        <label>Comments <span class="req">*</span></label>
        <button class="info-btn" onclick="showInfo('Comments','Any additional observations about the robot or match.')">i</button>
      </div>
      <textarea id="f_comments" placeholder="Notes about the robot or match..."></textarea>
    </div>

  </div>

  <div class="action-btns">
    <button class="gen-btn" id="genBtn" onclick="generateQR()" disabled style="opacity:0.4;cursor:not-allowed;">üì∑ Generate QR Code</button>
    <button class="rst-btn" onclick="resetForm()">‚Ü∫ Reset Form</button>
  </div>

  <div id="qrOutput">
    <canvas id="qrCanvas"></canvas>
    <p>Scan with your Bluetooth scanner ‚Äî tab-separated data fills across columns in Google Sheets</p>
    <button class="rst-btn" id="copyBtn" onclick="copyData()" style="margin-top:0.75rem;font-size:0.85rem;padding:0.55rem;">üìã Copy Data to Clipboard</button>
    <details style="margin-top:0.75rem;text-align:left;">
      <summary style="cursor:pointer;font-size:0.85rem;font-weight:700;color:var(--text3);padding:0.5rem;border:1.5px solid var(--border);border-radius:8px;list-style:none;text-align:center;">üîç Verify Submitted Data</summary>
      <table id="summaryTable" style="width:100%;margin-top:0.6rem;border-collapse:collapse;font-size:0.82rem;"></table>
    </details>
  </div>

</div>

<div class="modal-overlay" id="modal" onclick="closeModal(event)">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <p id="modalBody"></p>
    <button class="modal-close" onclick="closeInfoModal()">Got it</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// CYCLE DATA: stores array of timestamps (seconds) for each stampable field
const cycles = {
  fuel_scored:   [],
  fuel_shotfed:  [],
  fuel_scored_t: [],
  fuel_fed_t:    []
};

function b(id) { return document.getElementById(id).checked ? '1' : '0'; }

function avgCycleTime(timestamps) {
  if (timestamps.length < 2) return null;
  let total = 0;
  for (let i = 1; i < timestamps.length; i++) total += timestamps[i] - timestamps[i-1];
  return (total / (timestamps.length - 1)).toFixed(1);
}

function updateCycleUI(key) {
  const ts = cycles[key];
  const count = ts.length;
  const avg = avgCycleTime(ts);
  document.getElementById('cy_' + key + '_count').textContent = count;
  document.getElementById('cy_' + key + '_avg').textContent = avg !== null ? avg + 's' : '‚Äî';
  document.getElementById('ub_' + key).disabled = count === 0;
}

function stampCycle(key) {
  if (!timerRunning) return;
  cycles[key].push(timerSec);
  updateCycleUI(key);
}

function undoCycle(key) {
  if (cycles[key].length === 0) return;
  cycles[key].pop();
  updateCycleUI(key);
}

function setCycleButtonsEnabled(enabled) {
  ['fuel_scored','fuel_shotfed','fuel_scored_t','fuel_fed_t'].forEach(k => {
    document.getElementById('sb_' + k).disabled = !enabled;
  });
}

// THEME
function toggleTheme() {
  const html = document.documentElement;
  const cur = html.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : cur === 'light' ? 'cute' : 'dark';
  html.setAttribute('data-theme', next);
  document.getElementById('themeBtn').textContent = next === 'dark' ? '‚òÄÔ∏è Light' : next === 'light' ? 'üå∏ Cute' : 'üåô Dark';
}

// STEPPER
function step(id, delta) {
  const el = document.getElementById(id);
  el.value = Math.max(0, (parseInt(el.value) || 0) + delta);
}
function clamp(id, min) {
  const el = document.getElementById(id);
  if (parseInt(el.value) < min || el.value === '') el.value = min;
}

// TIMER
let timerSec = 0, timerRunning = false, timerInterval = null;
function timerToggle() {
  if (timerRunning) {
    clearInterval(timerInterval);
    timerRunning = false;
    document.getElementById('timerStartBtn').textContent = '‚ñ∂ Resume';
    setCycleButtonsEnabled(false);
  } else {
    timerInterval = setInterval(() => {
      timerSec++;
      const m = Math.floor(timerSec/60), s = timerSec%60;
      document.getElementById('timerDisplay').textContent = m+':'+(s<10?'0':'')+s;
    }, 1000);
    timerRunning = true;
    document.getElementById('timerStartBtn').textContent = '‚è∏ Pause';
    setCycleButtonsEnabled(true);
  }
}
function timerReset() {
  clearInterval(timerInterval);
  timerRunning = false;
  timerSec = 0;
  document.getElementById('timerDisplay').textContent = '0:00';
  document.getElementById('timerStartBtn').textContent = '‚ñ∂ Start';
  setCycleButtonsEnabled(false);
}
function currentTimestamp() {
  const m = Math.floor(timerSec/60), s = timerSec%60;
  return m+':'+(s<10?'0':'')+s;
}
function stampDied()        { document.getElementById('f_time_died').value = currentTimestamp(); }
function stampFunctioning() { document.getElementById('f_functioning').value = currentTimestamp(); }

// SHOWED UP COLLAPSE
function toggleShowedUp() {
  document.getElementById('mainForm').classList.toggle('collapsed', !document.getElementById('f_showed').checked);
}

// DIED COLLAPSE
function toggleDied() {
  document.getElementById('diedFields').classList.toggle('collapsed', !document.getElementById('f_died').checked);
}

// INFO MODAL
function showInfo(title, body) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').textContent = body;
  document.getElementById('modal').classList.add('open');
}
function closeInfoModal() { document.getElementById('modal').classList.remove('open'); }
function closeModal(e) { if (e.target === document.getElementById('modal')) closeInfoModal(); }

// REQUIRED VALIDATION
function checkRequired() {
  const ready = document.getElementById('f_name').value.trim() !== ''
             && document.getElementById('f_match').value.trim() !== ''
             && document.getElementById('f_team').value.trim() !== '';
  const btn = document.getElementById('genBtn');
  btn.disabled = !ready;
  btn.style.opacity = ready ? '1' : '0.4';
  btn.style.cursor = ready ? 'pointer' : 'not-allowed';
}
document.getElementById('f_name').addEventListener('input', checkRequired);
document.getElementById('f_match').addEventListener('input', checkRequired);
document.getElementById('f_team').addEventListener('input', checkRequired);

// QR GENERATION
let lastQRText = '';

function generateQR() {
  const fields = [
    document.getElementById('f_name').value,
    document.getElementById('f_match').value,
    document.getElementById('f_pos').value,
    document.getElementById('f_team').value,
    b('f_showed'),
    document.getElementById('f_startside').value,
    b('f_climbed'),
    b('f_attempted_climb'),
    String(cycles.fuel_scored.length),
    avgCycleTime(cycles.fuel_scored) !== null ? avgCycleTime(cycles.fuel_scored) : '0',
    document.getElementById('f_fuel_missed').value,
    String(cycles.fuel_shotfed.length),
    avgCycleTime(cycles.fuel_shotfed) !== null ? avgCycleTime(cycles.fuel_shotfed) : '0',
    document.getElementById('f_bump').checked ? '1' : '0',
    b('f_trench'),
    String(cycles.fuel_scored_t.length),
    avgCycleTime(cycles.fuel_scored_t) !== null ? avgCycleTime(cycles.fuel_scored_t) : '0',
    String(cycles.fuel_fed_t.length),
    avgCycleTime(cycles.fuel_fed_t) !== null ? avgCycleTime(cycles.fuel_fed_t) : '0',
    b('f_defense'),
    document.getElementById('f_climb_end').value,
    b('f_kept_scoring'),
    b('f_died'),
    document.getElementById('f_died').checked ? (document.getElementById('f_time_died').value || '0:00') : 'N/A',
    document.getElementById('f_died').checked ? (document.getElementById('f_functioning').value || '0') : 'N/A',
    b('f_tipped'),
    document.getElementById('f_comments').value,
  ];

  const text = fields.join('\t');
  lastQRText = text;

  const out = document.getElementById('qrOutput');
  const canvas = document.getElementById('qrCanvas');
  out.style.display = 'block';
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

  const tmp = document.createElement('div');
  tmp.style.display = 'none';
  document.body.appendChild(tmp);
  new QRCode(tmp, { text, width: 300, height: 300, correctLevel: QRCode.CorrectLevel.M });

  setTimeout(() => {
    const img = tmp.querySelector('img') || tmp.querySelector('canvas');
    canvas.width = 300; canvas.height = 300;
    const ctx = canvas.getContext('2d');
    if (img.tagName === 'IMG') {
      const i = new Image(); i.onload = () => ctx.drawImage(i,0,0); i.src = img.src;
    } else { ctx.drawImage(img,0,0); }
    document.body.removeChild(tmp);
    out.scrollIntoView({ behavior: 'smooth', block: 'center' });
    buildSummary();
  }, 100);
}

function buildSummary() {
  const rows = [
    ['Name', document.getElementById('f_name').value],
    ['Match Number', document.getElementById('f_match').value],
    ['Scouting Position', document.getElementById('f_pos').value],
    ['Team Number', document.getElementById('f_team').value],
    ['Showed Up?', document.getElementById('f_showed').checked ? 'TRUE' : 'FALSE'],
    ['Starting Side', document.getElementById('f_startside').value],
    ['Climbed Tower? (Auto)', document.getElementById('f_climbed').checked ? 'TRUE' : 'FALSE'],
    ['Attempted Climb? (Auto)', document.getElementById('f_attempted_climb').checked ? 'TRUE' : 'FALSE'],
    ['Fuel Scored (Auto) ‚Äî Cycles', String(cycles.fuel_scored.length)],
    ['Fuel Scored (Auto) ‚Äî Avg Cycle', avgCycleTime(cycles.fuel_scored) !== null ? avgCycleTime(cycles.fuel_scored) + 's' : '0'],
    ['Fuel Missed (Auto)', document.getElementById('f_fuel_missed').value],
    ['Fuel Shot/Fed (Auto) ‚Äî Cycles', String(cycles.fuel_shotfed.length)],
    ['Fuel Shot/Fed (Auto) ‚Äî Avg Cycle', avgCycleTime(cycles.fuel_shotfed) !== null ? avgCycleTime(cycles.fuel_shotfed) + 's' : '0'],
    ['Crossed Bump?', document.getElementById('f_bump').checked ? 'TRUE' : 'FALSE'],
    ['Crossed Trench?', document.getElementById('f_trench').checked ? 'TRUE' : 'FALSE'],
    ['Fuel Scored (Teleop) ‚Äî Cycles', String(cycles.fuel_scored_t.length)],
    ['Fuel Scored (Teleop) ‚Äî Avg Cycle', avgCycleTime(cycles.fuel_scored_t) !== null ? avgCycleTime(cycles.fuel_scored_t) + 's' : '0'],
    ['Fuel Fed (Teleop) ‚Äî Cycles', String(cycles.fuel_fed_t.length)],
    ['Fuel Fed (Teleop) ‚Äî Avg Cycle', avgCycleTime(cycles.fuel_fed_t) !== null ? avgCycleTime(cycles.fuel_fed_t) + 's' : '0'],
    ['Crossed Field / Played Defense?', document.getElementById('f_defense').checked ? 'TRUE' : 'FALSE'],
    ['Climbed Tower (Endgame)', document.getElementById('f_climb_end').value],
    ['Kept Scoring Until End?', document.getElementById('f_kept_scoring').checked ? 'TRUE' : 'FALSE'],
    ['Died?', document.getElementById('f_died').checked ? 'TRUE' : 'FALSE'],
    ['Approx. Time Robot Died', document.getElementById('f_time_died').value || '0:00'],
    ['Functioning Again?', document.getElementById('f_functioning').value || 'FALSE'],
    ['Tipped Over?', document.getElementById('f_tipped').checked ? 'TRUE' : 'FALSE'],
    ['Comments', document.getElementById('f_comments').value || '‚Äî'],
  ];
  const table = document.getElementById('summaryTable');
  table.innerHTML = rows.map((r, i) => `
    <tr style="background:${i%2===0 ? 'var(--bg3)' : 'var(--input-bg)'};">
      <td style="padding:0.4rem 0.6rem;font-weight:700;color:var(--text2);border:1px solid var(--border);width:55%;">${r[0]}</td>
      <td style="padding:0.4rem 0.6rem;color:var(--text);border:1px solid var(--border);">${r[1]}</td>
    </tr>`).join('');
}

function copyData() {
  if (!lastQRText) return;
  navigator.clipboard.writeText(lastQRText).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = '‚úÖ Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy Data to Clipboard', 2000);
  }).catch(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = '‚ùå Copy failed';
    setTimeout(() => btn.textContent = 'üìã Copy Data to Clipboard', 2000);
  });
}

// RESET
function resetForm() {
  document.getElementById('f_match').value = '0';
  document.getElementById('f_pos').value = 'Red 1';
  document.getElementById('f_team').value = '0';
  document.getElementById('f_showed').checked = true;
  document.getElementById('mainForm').classList.remove('collapsed');
  document.getElementById('f_startside').value = 'Center';
  timerReset();
  ['f_climbed','f_attempted_climb','f_climbed_t','f_attempted_climb_t','f_defense','f_kept_scoring','f_died','f_tipped'].forEach(id => {
    const el = document.getElementById(id); if (el) el.checked = false;
  });
  document.getElementById('diedFields').classList.add('collapsed');
  document.getElementById('f_time_died').value = '';
  document.getElementById('f_functioning').value = '';
  ['f_fuel_missed'].forEach(id => document.getElementById(id).value = '0');
  ['f_bump','f_trench'].forEach(id => document.getElementById(id).checked = false);
  // Reset cycles
  Object.keys(cycles).forEach(k => { cycles[k] = []; updateCycleUI(k); });
  document.getElementById('f_climb_end').value = "Didn't Climb";
  document.getElementById('f_comments').value = '';
  document.getElementById('qrOutput').style.display = 'none';
  checkRequired();
}
</script>
</body>
</html>
